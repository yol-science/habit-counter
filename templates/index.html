<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ç¿’æ…£ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="container">
  <h1>ãƒ©ã‚¤ãƒ•å¼ ç¿’æ…£ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</h1>

  <!-- ğŸ” ã“ã“ã«ç§»å‹• -->
  <div class="host-area">
    <input type="password" id="hostPassword" placeholder="ãƒ›ã‚¹ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="hostLogin()">ãƒ›ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div class="add-area">
    <input type="text" id="newHabit" placeholder="æ–°ã—ã„ç¿’æ…£ã‚’è¿½åŠ ">
    <button onclick="addHabit()">è¿½åŠ </button>
  </div>

  <div id="status" class="card-area"></div>
</div>

<script>
function heart(life){
  return "â¤ï¸".repeat(life) + "ğŸ–¤".repeat(3-life)
}

function add(activity){
  fetch("/api/add",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({activity})
  }).then(()=>refresh())
}

function addHabit(){
  const name = document.getElementById("newHabit").value
  if(!name) return

  fetch("/api/add_habit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  }).then(()=>{
    document.getElementById("newHabit").value=""
    refresh()
  })
}

function deleteHabit(name){
  fetch("/api/delete_habit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  }).then(refresh)
}

function refresh(){
  fetch("/api/today")
    .then(r=>r.json())
    .then(data=>{
      let output=""

      if(Object.keys(data).length === 0){
        output = "<p>ã¾ã ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“ ğŸŒ±</p>"
      } else {

        for(let key in data){
          output += `
          <div class="card">
            <h2>${key}</h2>
            <div class="life">${heart(data[key].life)}</div>
            <div class="total">ç´¯è¨ˆ: ${data[key].total}</div>
            <button onclick="add('${key}')">+1</button>
            <button onclick="deleteHabit('${key}')">å‰Šé™¤</button>
          `

          // ğŸ” ãƒ›ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã ã‘è¡¨ç¤º
          if(isHost){
            output += `
              <div class="host-edit">
                Life: <input type="number" id="life-${key}" value="${data[key].life}">
                Total: <input type="number" id="total-${key}" value="${data[key].total}">
                <button onclick="hostUpdate('${key}')">æ›´æ–°</button>
              </div>
            `
          }

          output += `</div>`
        }

      }

      document.getElementById("status").innerHTML = output
    })
}

let isHost = false;

function hostLogin(){
  const password = document.getElementById("hostPassword").value

  fetch("/api/host_login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({password})
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.message){
      isHost = true
      alert("ãƒ›ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ON")
      refresh()
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™")
    }
  })
}

function hostUpdate(name){
  const life = document.getElementById(`life-${name}`).value
  const total = document.getElementById(`total-${name}`).value

  fetch("/api/host_update",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name, life, total})
  }).then(refresh)
}

refresh()
</script>

</body>
</html>